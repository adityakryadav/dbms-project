<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Portal</title>
  <style>
    :root {
      /* Red→Green gradient background with white text */
      --bg: linear-gradient(135deg, #b91c1c 0%, #16a34a 100%);
      --panel: rgba(0,0,0,0.45);
      --muted: rgba(255,255,255,0.8);
      --text: #ffffff;
      --accent: #22c55e;
      --accent-2: #ffffff;
      --danger: #ef4444;
      --border: rgba(255,255,255,0.28);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    .sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 20px; position: sticky; top: 0; height: 100vh; }
    .brand { font-weight: 700; font-size: 1.2rem; letter-spacing: 0.4px; margin-bottom: 12px; }
    .sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 20px; }
    .nav a { display: block; padding: 10px 12px; border-radius: 8px; color: var(--text); text-decoration: none; margin-bottom: 8px; border: 1px solid transparent; }
    .nav a.active { background: rgba(255,255,255,0.12); border-color: var(--border); }
    .nav a:hover { background: rgba(255,255,255,0.08); }
    .content { padding: 24px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .header h1 { font-size: 1.4rem; margin: 0; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .grid { display: grid; gap: 16px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .muted { color: var(--muted); }
    .divider { height: 1px; background: var(--border); margin: 16px 0; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; }
    .status { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; }
    .status.upcoming { background: rgba(96,165,250,0.15); color: var(--accent-2); border: 1px solid rgba(96,165,250,0.4); }
    .status.completed { background: rgba(34,197,94,0.15); color: var(--accent); border: 1px solid rgba(34,197,94,0.4); }
    .status.cancelled { background: rgba(239,68,68,0.15); color: var(--danger); border: 1px solid rgba(239,68,68,0.4); }

    .input, select, textarea { width: 100%; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
    .label { display: block; font-size: 0.9rem; color: var(--muted); margin-bottom: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background: #0b1220; color: var(--text); cursor: pointer; }
    .btn.primary { background: var(--accent); color: #ffffff; border-color: #16a34a; font-weight: 600; }
    .btn.ghost { background: transparent; }
    .toolbar { display: flex; gap: 10px; align-items: center; }

    .section { display: none; }
    .section.active { display: block; }

    .kpi { display: flex; align-items: center; gap: 12px; }
    .kpi .val { font-size: 1.4rem; font-weight: 700; }
    .kpi .hint { color: var(--muted); }

    .footer { margin-top: 28px; color: var(--muted); font-size: 0.85rem; }

    .badge { display:inline-block; min-width:22px; padding:2px 6px; border-radius:999px; background: var(--accent-2); color:#0b1220; font-weight:700; font-size:.8rem; text-align:center; }
    .hidden { display:none; }
    .notice { background: #0b1220; border:1px solid var(--border); border-radius:8px; padding:10px 12px; margin:8px 0; }

    /* Auth Gate (Login / Signup overlay) */
    .auth-gate { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(0,0,0,0.15); backdrop-filter: blur(2px); z-index: 50; }
    .auth-card { width: 100%; max-width: 460px; background: rgba(0,0,0,0.55); border: 1px solid var(--border); border-radius: 14px; padding: 18px; color: var(--text); }
    .auth-title { margin: 0 0 8px; font-size: 1.4rem; font-weight: 800; }
    .auth-sub { margin: 0 0 12px; color: var(--muted); }
    .auth-switch { display: flex; gap: 8px; margin-bottom: 12px; }
    .auth-switch .btn { flex: 1; }
    .auth-form .label { margin-top: 8px; }
    .auth-actions { display: flex; gap: 8px; margin-top: 14px; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">GenriCycle • Doctor Portal</div>
      <div class="sub">Manage your profile, appointments, and schedule.</div>
      <nav class="nav" id="nav">
        <a href="#" data-section="profile" class="active">Profile</a>
        <a href="#" data-section="appointments">Appointments</a>
        <a href="#" data-section="schedule">Schedule</a>
        <a href="#" data-section="notifications">Notifications <span id="notifCount" class="badge hidden">0</span></a>
        <a href="#" data-section="settings">Settings</a>
        <div class="divider"></div>
        <a href="#" data-section="register">Register New Profile</a>
        <div class="divider"></div>
        <a href="index.html" class="ghost">← Back to Home</a>
      </nav>
    </aside>

    <main class="content">
      <header class="header">
        <h1 id="pageTitle">Doctor Profile</h1>
        <div class="toolbar">
          <button class="btn ghost" id="loginBtn">Login</button>
          <button class="btn" id="logoutBtn" style="display:none;">Logout</button>
          <button class="btn ghost" id="refreshBtn">Refresh</button>
          <button class="btn primary" id="quickAddBtn">Quick Add Appointment</button>
        </div>
      </header>

      <!-- Register Section -->
      <section class="section" id="register">
        <div class="card">
          <h2>Register as a Doctor</h2>
          <p class="muted">Fill in the required information to create your profile.</p>
          <div class="divider"></div>
          <form id="registerForm">
            <div class="row">
              <div>
                <label class="label" for="fullName">Full Name*</label>
                <input class="input" id="fullName" required />
              </div>
              <div>
                <label class="label" for="specialization">Specialization*</label>
                <input class="input" id="specialization" required />
              </div>
            </div>
            <div class="row">
              <div>
                <label class="label" for="licenseNo">License Number*</label>
                <input class="input" id="licenseNo" required />
              </div>
              <div>
                <label class="label" for="yearsExp">Years of Experience*</label>
                <input class="input" id="yearsExp" type="number" min="0" required />
              </div>
            </div>
            <div class="row">
              <div>
                <label class="label" for="email">Email*</label>
                <input class="input" id="email" type="email" required />
              </div>
              <div>
                <label class="label" for="phone">Phone*</label>
                <input class="input" id="phone" type="tel" required />
              </div>
            </div>
            <div>
              <label class="label" for="address">Clinic/Hospital Address*</label>
              <input class="input" id="address" required />
            </div>
            <div class="row">
              <div>
                <label class="label" for="hospital">Primary Hospital Affiliation</label>
                <input class="input" id="hospital" />
              </div>
              <div>
                <label class="label" for="languages">Languages</label>
                <input class="input" id="languages" placeholder="e.g., English, Hindi" />
              </div>
            </div>
            <div class="divider"></div>
            <div class="toolbar">
              <button class="btn" type="reset">Clear</button>
              <button class="btn primary" type="submit">Create Profile</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Profile Section -->
      <section class="section active" id="profile">
        <div class="grid cols-3">
          <div class="card kpi">
            <div>
              <div class="muted">Patients</div>
              <div class="val" id="kpiPatients">0</div>
            </div>
          </div>
          <div class="card kpi">
            <div>
              <div class="muted">Experience</div>
              <div class="val"><span id="kpiExp">0</span> yrs</div>
            </div>
          </div>
          <div class="card kpi">
            <div>
              <div class="muted">Rating</div>
              <div class="val">4.9</div>
            </div>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:16px;">
          <div class="card">
            <h3>Doctor Details</h3>
            <div class="divider"></div>
            <div class="grid cols-2">
              <div>
                <div class="muted">Name</div>
                <div id="profileName">—</div>
              </div>
              <div>
                <div class="muted">Specialization</div>
                <div id="profileSpec">—</div>
              </div>
              <div>
                <div class="muted">License No.</div>
                <div id="profileLicense">—</div>
              </div>
              <div>
                <div class="muted">Experience</div>
                <div><span id="profileExp">—</span> yrs</div>
              </div>
              <div>
                <div class="muted">Email</div>
                <div id="profileEmail">—</div>
              </div>
              <div>
                <div class="muted">Phone</div>
                <div id="profilePhone">—</div>
              </div>
              <div style="grid-column: 1 / -1;">
                <div class="muted">Address</div>
                <div id="profileAddress">—</div>
              </div>
              <div>
                <div class="muted">Hospital</div>
                <div id="profileHospital">—</div>
              </div>
              <div>
                <div class="muted">Languages</div>
                <div id="profileLangs">—</div>
              </div>
            </div>
          </div>
          <div class="card">
            <h3>Upcoming Schedule</h3>
            <div class="divider"></div>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Patient</th>
                  <th>Purpose</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="profileUpcoming">
                <tr><td colspan="5" class="muted">No appointments yet.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Appointments Section -->
      <section class="section" id="appointments">
        <div class="card">
          <h2>Booked Appointments</h2>
          <p class="muted">View and manage your appointments. Use the quick add below to simulate bookings.</p>
          <div class="divider"></div>
          <form id="addApptForm" style="margin-bottom:16px;">
            <div class="row">
              <div>
                <label class="label" for="apptDate">Date*</label>
                <input class="input" id="apptDate" type="date" required />
              </div>
              <div>
                <label class="label" for="apptTime">Time*</label>
                <input class="input" id="apptTime" type="time" required />
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <div>
                <label class="label" for="apptPatient">Patient*</label>
                <input class="input" id="apptPatient" required />
              </div>
              <div>
                <label class="label" for="apptPurpose">Purpose*</label>
                <input class="input" id="apptPurpose" required />
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <div>
                <label class="label" for="apptStatus">Status*</label>
                <select id="apptStatus" class="input" required>
                  <option value="Upcoming">Upcoming</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
              <div style="display:flex; align-items:flex-end;">
                <button class="btn primary" type="submit" style="width:100%;">Add Appointment</button>
              </div>
            </div>
          </form>

          <div class="grid cols-2">
            <div class="card">
              <h3>Today</h3>
              <div class="divider"></div>
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Patient</th>
                    <th>Purpose</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="todayAppointments">
                  <tr><td colspan="4" class="muted">No appointments today.</td></tr>
                </tbody>
              </table>
            </div>
            <div class="card">
              <h3>Upcoming</h3>
              <div class="divider"></div>
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Patient</th>
                    <th>Purpose</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="upcomingAppointments">
                  <tr><td colspan="5" class="muted">No upcoming appointments.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Schedule Section -->
      <section class="section" id="schedule">
        <div class="card">
          <h2>Schedule Overview</h2>
          <p class="muted">A compact view of your upcoming appointments.</p>
          <div class="divider"></div>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Patient</th>
                <th>Purpose</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="scheduleTable">
              <tr><td colspan="5" class="muted">No items to show.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Settings Section -->
      <section class="section" id="settings">
        <div class="card">
          <h2>Settings</h2>
          <p class="muted">Export or reset your local data.</p>
          <div class="divider"></div>
          <div class="toolbar">
            <button class="btn" id="exportBtn">Export Data</button>
            <button class="btn" id="resetBtn">Reset Data</button>
          </div>
          <div class="footer">Note: This portal stores data locally in your browser (localStorage). Integrate with your backend to persist data across devices.</div>
        </div>
      </section>

      <!-- Notifications Section -->
      <section class="section" id="notifications">
        <div class="card">
          <h2>Notifications</h2>
          <p class="muted">New bookings and updates appear here.</p>
          <div class="divider"></div>
          <div id="notifList">
            <div class="muted">No notifications yet.</div>
          </div>
        </div>
      </section>

      <!-- Public Booking Section (for users coming from Consult Doctors page) -->
      <section class="section" id="publicBooking">
        <div class="card">
          <h2>Book Appointment</h2>
          <p class="muted">You are booking with <strong id="publicDoctorName">Doctor</strong>. Please complete payment first on the Consult Doctors page.</p>
          <div class="divider"></div>
          <form id="publicBookForm">
            <div class="row">
              <div>
                <label class="label" for="pbDate">Date*</label>
                <input class="input" id="pbDate" type="date" required />
              </div>
              <div>
                <label class="label" for="pbTime">Time*</label>
                <input class="input" id="pbTime" type="time" required />
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <div>
                <label class="label" for="pbPatient">Your Name*</label>
                <input class="input" id="pbPatient" required />
              </div>
              <div>
                <label class="label" for="pbPurpose">Purpose*</label>
                <input class="input" id="pbPurpose" required />
              </div>
            </div>
            <div class="divider"></div>
            <div class="toolbar">
              <button class="btn" type="reset">Clear</button>
              <button class="btn primary" type="submit">Book Appointment</button>
            </div>
            <div id="pbHint" class="notice hidden">Please complete payment to enable booking.</div>
          </form>
        </div>
      </section>
    </main>
  </div>

  <!-- Full-screen Login / Signup Gate -->
  <div id="authGate" class="auth-gate">
    <div class="auth-card">
      <h2 class="auth-title">Doctor Portal</h2>
      <p class="auth-sub">Login or Sign Up to continue.</p>
      <div class="auth-switch">
        <button id="showLogin" class="btn primary">Login</button>
        <button id="showSignup" class="btn">Sign Up</button>
      </div>
      <form id="loginForm" class="auth-form">
        <label class="label" for="loginName">Name*</label>
        <input class="input" id="loginName" required />
        <label class="label" for="loginPassword">Password*</label>
        <input class="input" id="loginPassword" type="password" required />
        <div class="auth-actions">
          <button class="btn" type="reset">Clear</button>
          <button class="btn primary" type="submit">Login</button>
        </div>
      </form>
      <form id="signupForm" class="auth-form hidden">
        <label class="label" for="signupName">Full Name*</label>
        <input class="input" id="signupName" required />
        <label class="label" for="signupPassword">Password*</label>
        <input class="input" id="signupPassword" type="password" required />
        <label class="label" for="signupEmail">Email*</label>
        <input class="input" id="signupEmail" type="email" required />
        <label class="label" for="signupPhone">Phone*</label>
        <input class="input" id="signupPhone" type="tel" required />
        <label class="label" for="signupSpecialization">Specialization*</label>
        <input class="input" id="signupSpecialization" required />
        <label class="label" for="signupLicense">License Number*</label>
        <input class="input" id="signupLicense" required />
        <label class="label" for="signupExperience">Years of Experience*</label>
        <input class="input" id="signupExperience" type="number" min="0" required />
        <label class="label" for="signupAddress">Clinic/Hospital Address*</label>
        <input class="input" id="signupAddress" required />
        <label class="label" for="signupHospital">Primary Hospital Affiliation</label>
        <input class="input" id="signupHospital" />
        <label class="label" for="signupLanguages">Languages</label>
        <input class="input" id="signupLanguages" placeholder="e.g., English, Hindi" />
        <div class="auth-actions">
          <button class="btn" type="reset">Clear</button>
          <button class="btn primary" type="submit">Sign Up</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const STORAGE = {
      profile: 'doctorProfile',
      appts: 'doctorAppointments',
      auth: 'doctorAuth',
      notifs: 'doctorNotifications'
    };

    const nav = document.getElementById('nav');
    const pageTitle = document.getElementById('pageTitle');
    const sections = ['profile','appointments','schedule','notifications','settings','register','publicBooking'];

    function getProfile() {
      try { return JSON.parse(localStorage.getItem(STORAGE.profile)) || null; } catch { return null; }
    }
    function setProfile(p) { localStorage.setItem(STORAGE.profile, JSON.stringify(p)); }

    function getAppts() {
      try { return JSON.parse(localStorage.getItem(STORAGE.appts)) || []; } catch { return []; }
    }
    function setAppts(a) { localStorage.setItem(STORAGE.appts, JSON.stringify(a)); }

    function getAuth() {
      try { return JSON.parse(localStorage.getItem(STORAGE.auth)) || null; } catch { return null; }
    }
    function setAuth(a) { localStorage.setItem(STORAGE.auth, JSON.stringify(a)); }

    function getNotifs() {
      try { return JSON.parse(localStorage.getItem(STORAGE.notifs)) || []; } catch { return []; }
    }
    function setNotifs(n) { localStorage.setItem(STORAGE.notifs, JSON.stringify(n)); }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    function setActive(name) {
      sections.forEach(s => {
        const el = document.getElementById(s);
        if (el) el.classList.toggle('active', s === name);
      });
      [...nav.querySelectorAll('a[data-section]')].forEach(a => a.classList.toggle('active', a.dataset.section === name));
      pageTitle.textContent = name.charAt(0).toUpperCase() + name.slice(1);
    }

    function renderAuth() {
      const auth = getAuth();
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      loginBtn.style.display = auth ? 'none' : 'inline-block';
      logoutBtn.style.display = auth ? 'inline-block' : 'none';
    }

    function seedApptsIfEmpty() {
      const a = getAppts();
      if (a.length) return;
      const t = todayISO();
      const seed = [
        { date: t, time: '09:30', patient: 'John Doe', purpose: 'Follow-up', status: 'Upcoming' },
        { date: t, time: '11:00', patient: 'Aisha Khan', purpose: 'Consultation', status: 'Upcoming' },
        { date: addDaysISO(t, 1), time: '10:00', patient: 'Ravi Verma', purpose: 'General Checkup', status: 'Upcoming' },
        { date: addDaysISO(t, 3), time: '14:00', patient: 'Neha Patel', purpose: 'Blood Report Review', status: 'Upcoming' }
      ];
      setAppts(seed);
    }

    function addDaysISO(iso, days) {
      const d = new Date(iso);
      d.setDate(d.getDate()+days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    function renderProfile() {
      const p = getProfile();
      const appts = getAppts();
      const el = id => document.getElementById(id);
      el('profileName').textContent = p?.fullName || '—';
      el('profileSpec').textContent = p?.specialization || '—';
      el('profileLicense').textContent = p?.licenseNo || '—';
      el('profileExp').textContent = p?.yearsExp ?? '—';
      el('profileEmail').textContent = p?.email || '—';
      el('profilePhone').textContent = p?.phone || '—';
      el('profileAddress').textContent = p?.address || '—';
      el('profileHospital').textContent = p?.hospital || '—';
      el('profileLangs').textContent = p?.languages || '—';
      // KPIs
      document.getElementById('kpiExp').textContent = p?.yearsExp ?? 0;
      document.getElementById('kpiPatients').textContent = appts.length;
      // Upcoming list in profile
      renderUpcomingInto('profileUpcoming');
    }

    function renderAppointments() {
      renderTodayInto('todayAppointments');
      renderUpcomingInto('upcomingAppointments');
      renderUpcomingInto('scheduleTable');
    }

    function renderNotifications() {
      const list = document.getElementById('notifList');
      const badge = document.getElementById('notifCount');
      const items = getNotifs();
      badge.textContent = items.length;
      badge.classList.toggle('hidden', items.length === 0);
      list.innerHTML = '';
      if (!items.length) {
        list.innerHTML = '<div class="muted">No notifications yet.</div>';
        return;
      }
      items.slice().reverse().forEach(n => {
        const d = document.createElement('div');
        d.className = 'notice';
        d.innerHTML = `<strong>${escapeHtml(n.title || 'New Booking')}</strong><div class="muted">${escapeHtml(n.message)} • ${new Date(n.ts).toLocaleString()}</div>`;
        list.appendChild(d);
      });
    }

    function renderTodayInto(tbodyId) {
      const t = todayISO();
      const appts = getAppts().filter(a => a.date === t);
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';
      if (!appts.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="muted">No appointments today.</td></tr>`;
        return;
      }
      appts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.time}</td>
          <td>${escapeHtml(a.patient)}</td>
          <td>${escapeHtml(a.purpose)}</td>
          <td><span class="status ${a.status.toLowerCase()}">${a.status}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderUpcomingInto(tbodyId) {
      const t = todayISO();
      const appts = getAppts().filter(a => a.date >= t);
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';
      if (!appts.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No upcoming appointments.</td></tr>`;
        return;
      }
      appts.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
      appts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.date}</td>
          <td>${a.time}</td>
          <td>${escapeHtml(a.patient)}</td>
          <td>${escapeHtml(a.purpose)}</td>
          <td><span class="status ${a.status.toLowerCase()}">${a.status}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // Navigation
    nav.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-section]');
      if (!a) return;
      e.preventDefault();
      const section = a.dataset.section;
      setActive(section);
    });

    // Register form
    const registerForm = document.getElementById('registerForm');
    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const profile = {
        fullName: document.getElementById('fullName').value.trim(),
        specialization: document.getElementById('specialization').value.trim(),
        licenseNo: document.getElementById('licenseNo').value.trim(),
        yearsExp: Number(document.getElementById('yearsExp').value || 0),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        hospital: document.getElementById('hospital').value.trim(),
        languages: document.getElementById('languages').value.trim()
      };
      if (!profile.fullName || !profile.specialization || !profile.licenseNo || !profile.email || !profile.phone || !profile.address) {
        alert('Please fill all required fields marked with *');
        return;
      }
      setProfile(profile);
      alert('Profile created successfully!');
      renderProfile();
      setActive('profile');
    });

    // Add appointment form
    const addApptForm = document.getElementById('addApptForm');
    addApptForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const appt = {
        date: document.getElementById('apptDate').value,
        time: document.getElementById('apptTime').value,
        patient: document.getElementById('apptPatient').value.trim(),
        purpose: document.getElementById('apptPurpose').value.trim(),
        status: document.getElementById('apptStatus').value
      };
      if (!appt.date || !appt.time || !appt.patient || !appt.purpose || !appt.status) {
        alert('Please complete all fields.');
        return;
      }
      const arr = getAppts();
      arr.push(appt);
      setAppts(arr);
      // notify
      const notifs = getNotifs();
      notifs.push({ title:'Appointment Added', message:`${appt.patient} at ${appt.date} ${appt.time}`, ts: Date.now() });
      setNotifs(notifs);
      renderNotifications();
      addApptForm.reset();
      renderAppointments();
      renderProfile();
    });

    // Quick add demo
    document.getElementById('quickAddBtn').addEventListener('click', () => {
      const t = todayISO();
      const arr = getAppts();
      arr.push({ date: t, time: '16:00', patient: 'Walk-in', purpose: 'Quick consult', status: 'Upcoming' });
      setAppts(arr);
      renderAppointments();
      renderProfile();
      const notifs = getNotifs();
      notifs.push({ title:'Quick Booking', message:`Walk-in at ${t} 16:00`, ts: Date.now() });
      setNotifs(notifs);
      renderNotifications();
      alert('Added a demo appointment at 16:00 today.');
    });

    // Settings buttons
    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = {
        profile: getProfile(),
        appointments: getAppts()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'doctor_portal_export.json'; a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('This will clear your local profile and appointments. Continue?')) return;
      localStorage.removeItem(STORAGE.profile);
      localStorage.removeItem(STORAGE.appts);
      seedApptsIfEmpty();
      renderProfile();
      renderAppointments();
      setActive('register');
    });

    // Refresh
    document.getElementById('refreshBtn').addEventListener('click', () => {
      renderProfile();
      renderAppointments();
      renderNotifications();
    });

    // Auth Gate controls
    const authGate = document.getElementById('authGate');
    const loginFormEl = document.getElementById('loginForm');
    const signupFormEl = document.getElementById('signupForm');
    document.getElementById('showLogin').addEventListener('click', () => {
      loginFormEl.classList.remove('hidden');
      signupFormEl.classList.add('hidden');
    });
    document.getElementById('showSignup').addEventListener('click', () => {
      signupFormEl.classList.remove('hidden');
      loginFormEl.classList.add('hidden');
    });

    loginFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('loginName').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!name || !password) { alert('Please fill all fields.'); return; }
      
      // Check if doctor exists in local storage
      const doctors = JSON.parse(localStorage.getItem('doctors') || '[]');
      const doctor = doctors.find(d => d.name === name && d.password === password);
      
      if (!doctor) {
        alert('Invalid name or password');
        return;
      }
      
      // Set auth and profile from stored doctor data
      setAuth({ name, ts: Date.now() });
      setProfile(doctor.profile);
      
      authGate.style.display = 'none';
      renderAuth();
      renderProfile();
      setActive('profile');
    });

    signupFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('signupName').value.trim();
      const password = document.getElementById('signupPassword').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const phone = document.getElementById('signupPhone')?.value.trim();
      const specialization = document.getElementById('signupSpecialization')?.value.trim();
      const licenseNo = document.getElementById('signupLicense')?.value.trim();
      const yearsExp = document.getElementById('signupExperience')?.value;
      const address = document.getElementById('signupAddress')?.value.trim();
      const hospital = document.getElementById('signupHospital')?.value.trim();
      const languages = document.getElementById('signupLanguages')?.value.trim();
      
      if (!name || !password || !email || !phone || !specialization || !licenseNo || !yearsExp || !address) {
        alert('Please fill all required fields.');
        return;
      }
      
      // Create doctor profile
      const profile = {
        fullName: name,
        specialization,
        licenseNo,
        yearsExp: Number(yearsExp || 0),
        email,
        phone,
        address,
        hospital,
        languages
      };
      
      // Store doctor in local storage
      const doctors = JSON.parse(localStorage.getItem('doctors') || '[]');
      doctors.push({
        name,
        password,
        profile
      });
      localStorage.setItem('doctors', JSON.stringify(doctors));
      
      // Set auth and profile
      setAuth({ name, ts: Date.now() });
      setProfile(profile);
      
      authGate.style.display = 'none';
      renderAuth();
      renderProfile();
      setActive('profile');
    });

    // Login / Logout
    document.getElementById('loginBtn').addEventListener('click', () => {
      authGate.style.display = 'flex';
      loginFormEl.classList.remove('hidden');
      signupFormEl.classList.add('hidden');
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem(STORAGE.auth);
      alert('Logged out');
      renderAuth();
      // Show gate again on logout
      authGate.style.display = 'flex';
      setActive('profile');
    });

    // Public booking (from consult-doctors)
    const publicForm = document.getElementById('publicBookForm');
    publicForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const params = new URLSearchParams(location.search);
      const paid = params.get('paid') === '1';
      if (!paid) {
        const hint = document.getElementById('pbHint');
        hint.classList.remove('hidden');
        hint.textContent = 'Payment not confirmed. Please pay on Consult Doctors page.';
        return;
      }
      const appt = {
        date: document.getElementById('pbDate').value,
        time: document.getElementById('pbTime').value,
        patient: document.getElementById('pbPatient').value.trim(),
        purpose: document.getElementById('pbPurpose').value.trim(),
        status: 'Upcoming'
      };
      if (!appt.date || !appt.time || !appt.patient || !appt.purpose) {
        alert('Please complete all fields.');
        return;
      }
      const arr = getAppts();
      arr.push(appt);
      setAppts(arr);
      const notifs = getNotifs();
      notifs.push({ title:'New Booking', message:`${appt.patient} booked ${appt.date} ${appt.time}`, ts: Date.now() });
      setNotifs(notifs);
      renderAppointments();
      renderProfile();
      renderNotifications();
      publicForm.reset();
      alert('Appointment booked!');
    });

    // Init
    (function init(){
      seedApptsIfEmpty();
      const prof = getProfile();
      const auth = getAuth();
      if (!auth) {
        authGate.style.display = 'flex';
      } else {
        renderAuth();
        if (prof) {
          renderProfile();
          setActive('profile');
        } else {
          setActive('register');
        }
      }
      renderAppointments();
      renderNotifications();
      renderAuth();

      // Detect public booking mode
      const params = new URLSearchParams(location.search);
      const doctor = params.get('doctor');
      const isPublic = params.get('public') === '1';
      if (isPublic) {
        const nameEl = document.getElementById('publicDoctorName');
        if (doctor) nameEl.textContent = doctor;
        setActive('publicBooking');
        const paid = params.get('paid') === '1';
        const hint = document.getElementById('pbHint');
        hint.classList.toggle('hidden', paid);
        if (!paid) hint.textContent = 'Please complete payment to enable booking.';
      }
    })();
  </script>
</body>
</html>